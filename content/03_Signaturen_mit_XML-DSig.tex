% vim: set tw=160:

\chapter{Signaturen mit \glsentrytext{xml-dsig}}
\index{XML-DSig}
\label{chap:XML-DSig}
Von der \gls{ietf} und dem \gls{w3c} entwickelt, hat die \gls{xml-dsig} Spezifikation zum Ziel, die kryptografischen Sicherheitsfunktionen Integrität,
Authentizität und Verbindlichkeit für beliebige Daten, die entweder direkt im \gls{xml}-Format vorliegen oder über \glspl{uri} ansprechbar sind, anwendbar zu
machen \cite{krypto-pki-internet}.

\gls{xml-dsig} definiert einen \gls{xml}-Dialekt der Informationen über die zu signierenden Inhalte, die Signaturen selbst und die zur Prüfung der Signaturen
notwendigen Schlüsselinformationen aufnimmt. Um \gls{xml-dsig} von anderen \gls{xml}-Dialekten abzugrenzen wurde ihm der \gls{xml-ns}
\url{http://www.w3.org/2000/09/xmldsig#} zugewiesen \cite{xml-dsig:w3c}.

\section{Struktur einer Signatur}
Eine Signatur mit \gls{xml-dsig} besteht aus mehreren Elementen die sich alle innerhalb von \xmlelem{Signature} befinden. \fref{lst:xml-dsig-structure} zeigt
die grundlegende Struktur einer Signatur mit \gls{xml-dsig}.

\lstinputlisting[language=XML,
                 float=t,
                 caption={Struktur von \texorpdfstring{\protect\Glsentryname{xml-dsig}}{XML-DSig}},
                 label=lst:xml-dsig-structure,
                 emph={Signature}]{source/xml-dsig-structure.xml}

Im folgenden werden die einzelnen Elemente dieser Struktur in ihrer Funktion näher beschrieben. 

\section{Schlüsselinformation}
Das optionale Element \xmlelem{KeyInfo} enthält Informationen zum Schlüssel, der bei der Erstellung der Signatur verwendet wurde. Diese Informationen sollen es
ermöglichen, dass der Empfänger den passenden Schlüssel zur Validierung der Signatur beziehen kann. \gls{xml-dsig} definiert eine Menge von
Schlüsseltypen, unter anderem für \gls{x509} und \gls{openpgp}, die jedoch auch abhängig von der Anwendung mit Hilfe neuer \glspl{xml-ns} erweitert werden
können. Das in \fref{lst:xml-dsig-keyinfo} dargestellte \gls{xml}-Schema zeigt die bereits definierten Elemente von \gls{xml-dsig} zur Aufnahme von
Schlüsselinformationen.

\lstinputlisting[language=XML,
                 caption={Schema von \protect\xmlelem{KeyInfo}},
                 label=lst:xml-dsig-keyinfo,
                 emph={element}]{source/xml-dsig-keyinfo.xml}

Ist \xmlelem{KeyInfo} nicht Bestandteil der Signatur, dann wird davon ausgegangen, dass der Empfänger über den Kontext der Nachricht und der Signatur in der
Lage ist, die nötigen Schlüsselinformationen zu beziehen.

Über \xmlelem{KeyName} ist es dem Ersteller der Signatur möglich, den Schlüssel zu benennen, der für die Signatur benutzt wurde. Für \gls{x509} kann dies ein
\gls{dn} sein, für \gls{openpgp} eine E-Mail-Adresse. Über \xmlelem{KeyValue} ist es auch möglich, die für den \gls{dsa} oder das \gls{rsa} Verfahren
benötigten Schlüsselinformationen direkt in der Signatur einzubetten \cite{xml-dsig:w3c}.  

Alternativ können mit dem Element \xmlelem{RetrievalMethod} die Schlüsselinformationen über \glspl{uri} referenziert werden. Dies können zum Beispiel
\gls{x509}-Zertifikate sein, die bereits in dem zu signierenden \gls{xml}-Dokument enthalten sind. Dadurch entspricht \xmlelem{RetrievalMethod} bis auf
das Fehlen der Elemente \xmlelem{DigestMethod} und \xmlelem{DigestValue} in seinem Verhalten dem Element \xmlelem{Reference}, das in
\fref{sec:XML-DSig:Referenzen} näher beschrieben wird.

\subsection{\glsentrytext{openpgp}}
\index{OpenPGP}
Für Schlüssel nach \gls{openpgp} wird das Element \xmlelem{PGPData} im \gls{xml-ns} \url{http://www.w3.org/2000/09/xmldsig#PGPData}
definiert \cite{xml-sec-uri:ietf}. Es kann zwei weitere Elemente aufzunehmen: \xmlelem{PGPKeyID} nimmt die ID eines \gls{openpgp}-Schlüsselpaares
auf, welche aus 8 \glspl{oktett} besteht und die niedrigsten 64 Bit aus der \gls{sha1} Prüfsumme des Schlüssels darstellen \cite{openpgp:ietf}. Über 
\xmlelem{PGPKeyID} ist der passende Schlüssel bereits eindeutig identifiziert, es besteht mit dem Element \xmlelem{PGPKeyPacket} jedoch auch die Variante, den
vollständigen öffentlichen Teil des Schlüsselpaares in der Signatur einzubetten. Dafür wird das Schlüsselmaterial mit \gls{base64} kodiert und als Inhalt in das
Element geschrieben \cite{xml-dsig:w3c}. Mindestens eines der beiden Elemente muss innerhalb von \xmlelem{PGPData} vorhanden sein. Wenn beide angeführt sind,
müssen sie den selben Schlüssel referenzieren.

\fref{lst:xml-dsig-keyinfo-openpgp} zeigt ein Beispiel für eine Struktur mit den zuvor genannten Unterelementen, welche auf den \gls{openpgp}-Schlüssel des Autors
referenzieren. In \fref{lin:xml-dsig-keyinfo-openpgp-keyid} wird der Schlüssel über seine ID verankert und ab \fref{lin:xml-dsig-keyinfo-openpgp-keypacket} als
vollständige Kopie in der Signatur eingebettet.

\lstinputlisting[language=XML,
                 float=t,
                 caption={Beispiel einer Struktur für \protect\xmlelem{PGPData}},
                 label=lst:xml-dsig-keyinfo-openpgp,
                 emph={PGPData,PGPKeyID,PGPKeyPacket}]{source/xml-dsig-keyinfo-openpgp.xml}

\subsection{\glsentrytext{x509}}
\index{X.509v3}
Informationen über ein für die Signatur verwendetes \gls{x509}-Zertifikat können unterhalb des Elements \xmlelem{X509Data} im dafür vorgesehenen \gls{xml-ns}
\url{http://www.w3.org/2000/09/xmldsig#X509Data} abgelegt werden. 
Ähnlich wie \xmlelem{PGPData} enthält es Schlüsselinformationen die zur Validierung der Signatur benötigt werden.  Dafür muss mindestens eines der Elemente aus
\fref{tab:x509data-elements} vorhanden sein. Wenn zwei oder mehrere dieser Elemente sich innerhalb eines \xmlelem{X509Data} befinden, so müssen sie alle das
selbe Zertifikat referenzieren. In \fref{lst:xml-dsig-keyinfo-x509} sind drei Zertifikate über unterschiedliche Methoden referenziert. 

\begin{table}
    \centering
    \begin{tabularx}{\textwidth}{ l X }
        Element  & Inhalt \\
        \hline
        \hline
        \xmlelem{X509IssuerSerial} & Name und Seriennummer des Zertifikats \\
        \hline
        \xmlelem{X509SKI} & Mit \gls{base64} kodierter Inhalt der "`SubjectKeyIdentifier"' Erweiterung des Zertifikats \\
        \hline
        \xmlelem{X509Certificate} & Mit \gls{base64} kodierter Inhalt des gesamten Zertifikats \\
        \hline
        \xmlelem{X509SubjectName} & \gls{dn} des Subject-Felds des Zertifikats \\
        \hline
    \end{tabularx}
    \caption{Elemente in \xmlelem{X509Data} und ihr Inhalt}
    \label{tab:x509data-elements}
\end{table}

\lstinputlisting[float=b,
                 language=XML,
                 caption={Beispiel einer Struktur für \protect\xmlelem{X509Data}},
                 label=lst:xml-dsig-keyinfo-x509,
                 emph={X509Data,X509IssuerSerial,X509SKI,X509Certificate,X509SubjectName}]{source/xml-dsig-keyinfo-x509.xml}

\section{Signaturinformation}
Analog zu \xmlelem{KeyInfo} wird das Element \xmlelem{SignedInfo} verwendet, um Informationen über die Signatur selbst zu speichern. Dazu gehören die benutzte
Signaturmethode, die Art der Transformation der Daten vor der Signierung sowie die Referenzen auf die signierten Daten und ihre Hash-Prüfsummen.

Alle in \gls{xml-dsig} anwendbaren Algorithmen werden über eigene \glspl{uri} referenziert. So kann das Signaturverfahren mit den \glspl{uri} aus
\fref{tab:xml-dsig-signature-method-uri} angegeben werden. Dazu muss für das Element \xmlelem{SignatureMethod} das obligatorische Attribut
\xmlattr{SignatureMethod}{Algorithm} mit der \gls{uri} eines Algorithmus befüllt werden.

\begin{table}
    \centering
    \begin{tabularx}{\textwidth}{ l X }
        Signaturmethode & \gls{uri} \\
        \hline
        \hline
        \gls{dsa}-\gls{sha1} & \url{http://www.w3.org/2000/09/xmldsig\#dsa-sha1} \\
        \hline
        \gls{rsa}-\gls{sha1} & \url{http://www.w3.org/2000/09/xmldsig\#rsa-sha1} \\
        \hline
    \end{tabularx}
    \caption{\protect\glspl{uri} für die Verwendung in \xmlelem{SignatureMethod}}
    \label{tab:xml-dsig-signature-method-uri}
\end{table}

\lstinputlisting[language=HTML,
                 float=t,
                 caption={Beispiel 1 für eine Formatierung in \glsentrytext{xml}},
                 label={lst:xml-format-example-1},
                 showspaces=true,
                 showtabs=true,
                 tab=\rightarrowfill]{source/xml-format-example-1.xml}

\lstinputlisting[language=HTML,
                 float=t,
                 caption={Beispiel 2 für eine Formatierung in \glsentrytext{xml}},
                 label={lst:xml-format-example-2},
                 showspaces=true,
                 showtabs=true,
                 tab=\rightarrowfill]{source/xml-format-example-2.xml}

Ein besonderes Problem beim Signieren von Inhalten, die im \gls{xml}-Format vorliegen entsteht, wenn mehrere Implementierungen von
\gls{xml}-Verarbeitungsprogrammen, jeweils unterschiedliche Formatierungen benutzen. So könnte ein Verarbeitungsprogramm das \gls{xhtml}-Dokument aus
\fref{lst:xml-format-example-1} einlesen und später mit der in \fref{lst:xml-format-example-2} gezeigten Formatierung abspeichern. Beide Formate unterscheiden sich
in der Groß- und Kleinschreibung der Elementnamen, sowie der Verwendung von Leerzeichen. Strukturell und inhaltlich sind sie trotzdem identisch.

Eine Signatur sollte deshalb nicht auf die binäre Repräsentation eines Dokumentes angewendet werden, sondern idealerweise auf seine kanonisierte
Struktur und den Inhalt. Dies geschieht bei \gls{xml-dsig} über den speziellen Zwischenschritt der \gls{c14n}, welche Struktur und Inhalt von \gls{xml} in eine kanonische 
Form überführt\cite{xml-c14n:w3c,xml-exc-c14n:w3c}, welche dann schließlich die zu signierenden Information bildet. Dadurch wird sichergestellt, dass die Signatur 
unabhängig von der Formatierung überprüft werden kann und nur Änderungen an der Struktur oder dem Inhalt die Integrität der Signatur beeinflussen. 

Bei \gls{xml-dsig} wird die Signatur nicht direkt über die zu schützenden Informationen gebildet, sondern es werden die gesamten Informationen innerhalb von
\xmlelem{SignedInfo} signiert. Die Verbindung zwischen den zu schützenden Informationen und der Signatur wird in \fref{sec:XML-DSig:Referenzen} näher erläutert.

Da \xmlelem{SignedInfo} selbst dem Problem der unterschiedlichen Formatierungen unterliegt, wird über das Element \xmlelem{CanonicalizationMethod} ein
Algorithmus angegeben, der die Umwandlung von \xmlelem{SignedInfo} in ein kanonisches Format festlegt. Innerhalb von \xmlelem{SignedInfo} muss das Element
\xmlelem{CanonicalizationMethod} genau einmal vorhanden sein. Der Algorithmus wird über das obligatorische Attribut \xmlattr{CanonicalizationMethod}{Algorithm}
bei \xmlelem{CanonicalizationMethod} definiert. Als Wert kommt eine von vier möglichen \glspl{uri} zu Einsatz, welche in \cite{xml-dsig:w3c} spezifiziert sind.

\section{Referenzen}
\label{sec:XML-DSig:Referenzen}
Um Daten für die \gls{c14n} zu bekommen, benötigt \gls{xml-dsig} Referenzen, welche auf die signierten Informationen verweisen. Diese Information wird über das 
Element \xmlelem{Reference} zur Verfügung gestellt, welches mehrfach in \xmlelem{SignedInfo} enthalten sein kann. Jedes Vorkommen dieses Elements stellt einen
Verweis auf eine signierte Information dar. Der Verweis ist in Form eines \gls{uri} im optionalen Attribut \xmlattr{Reference}{URI} hinterlegt. Wenn
\xmlattr{Reference}{URI} nicht definiert ist, wird davon ausgegangen, dass die Applikation den Verweis aus dem Kontext der Signatur beziehen kann. Die
Autoren von \gls{xml-dsig} empfehlen, dass zumindest \glspl{uri} aus dem \gls{http}-Schema aufgelöst werden können \cite{xml-dsig:w3c}. Ein entsprechendes
Beispiel für Informationen die über \gls{http} referenziert werden, ist in \fref{lst:xml-dsig-signedinfo-reference} in der Zeile
\ref{lin:xml-dsig-signedinfo-reference-http} zu sehen.

Es können jedoch auch Informationen referenziert werden, die sich im selben \gls{xml}-Dokument wie die Signatur befinden. Dafür können im Attribut
\xmlattr{Reference}{URI} auch \gls{xpointer} benutzt werden. Dabei muss sichergestellt werden, dass der Verweis gültige \gls{xml}-Elemente findet.
\fref{lst:xml-dsig-signedinfo-reference} zeigt auf Zeile \ref{lin:xml-dsig-signedinfo-reference-xpointer} wie ein solcher Verweis innerhalb des \gls{xml}-Dokuments,
das die Signatur enthält, möglich ist.

Unterhalb von \xmlelem{Reference} sind je eine Instanz der Elemente \xmlelem{DigestMethod} und \xmlelem{DigestValue} vorgeschrieben. \xmlelem{DigestMethod} legt
über das Attribut \xmlattr{DigestMethod}{Algorithm} den Algorithmus zur Berechnung der Hash-Prüfsumme der, im übergeordenten Element \xmlelem{Reference} verwiesenen,
Informationen fest. Die Identifikation des Algorithmus erfolgt über einen \gls{uri}, wobei \gls{xml-dsig} hierfür nur \gls{sha1}, mit dem \gls{uri}
\url{http://www.w3.org/2000/09/xmldsig#sha1}, festlegt. Der Inhalt von \xmlelem{DigestValue} ist die, mit \gls{base64} kodierte, Hash-Prüfsumme des
Algorithmus. Diese muss nicht zwingend über die Gesamtheit der referenzierten Informationen gebildet werden. Bevor der Algorithmus angewendet wird, können zuvor
noch sogenannte Transformationen auf sie angewendet werden, die die Daten umwandeln und filtern.

\lstinputlisting[language=XML,
                 caption={Beispiele für \protect\xmlelem{Reference}},
                 label={lst:xml-dsig-signedinfo-reference},
                 emph={Reference,Object}]{source/xml-dsig-signedinfo-reference.xml}

\section{Transformationen}
\label{sec:XML-DSig:Transformationen}
Die Referenzierung auf Informationen alleine ist oft nicht genug, um aussagekräftige Signaturen zu erstellen, die nur die wirklich relevanten Bereiche eines
Dokuments umfassen. Mit dem Element \xmlelem{Transformation}, welches optional innerhalb von \xmlelem{Reference} verwendet werden kann, ist es möglich,
Transformationen zu definieren, die in der Reihenfolge ihrer Definition angewandt werden. Die erste Transformation erhält dabei ihre Eingabedaten aus der
Dereferenzierung des \gls{uri} des übergeordneten \xmlelem{Reference}-Elements. Danach werden die transformierten Daten an die nächste Transformation in der
Reihe übergeben. Die Ausgabe der letzten Transformation wird dann zur Berechnung der Hash-Prüfsumme, welche in \xmlelem{DigestValue} gespeichert wird, benutzt.

Als Transformationen stehen \gls{c14n}, \gls{base64}, \gls{xpath} und \gls{xslt} zur Verfügung. \gls{xpath} und \gls{xslt} sind geeignet, bestimmte Bereiche aus
einem \gls{xml}-Dokument zu extrahieren und somit den Bereich der Signatur exakt zu begrenzen. \gls{c14n} bietet sich als eine der letzten
Transformationen in der Reihe an, da sie die Überführung des Transformationsergebnisses in eine kanonische Form bewerkstelligt und somit wieder Struktur und
Inhalt von der Formatierung trennt. Eine Transformation mit \gls{base64} ist nur bei Referenzen auf binäre Daten sinnvoll. Da \gls{base64} kein gültiges
\gls{xml} als Ausgabe der Transformation liefert, sind nachgeschaltete Transformationen mit \gls{xpath} und \gls{xslt} nicht mehr möglich \cite{xml-dsig:w3c}.

\subsection{\glsentrytext{xpath}}
\index{XPath}
\label{sec:XML-DSig:Transformationen:XPath}
Um auf bestimmte Bereiche in einem \gls{xml}-Dokument zu zugreifen, eignet sich besonders \gls{xpath} \cite{xml:oreilly}. Es handelt sich dabei um eine
Abfragesprache, um Elemente und Attribute in einem \gls{xml}-Dokument zu adressieren. Sie wurde für die Verwendung in \gls{xslt} und \gls{xpointer} entworfen
\cite{xpath:w3c}, findet aber auch direkt in \gls{xml-dsig} Verwendung.

Bei einer Transformation mit \gls{xpath} muss die Eingabe aus gültigen \gls{xml}-Knoten bestehen \cite{xml-dsig:w3c}. Diese können entweder direkt aus einem
\gls{xml}-Dokument stammen oder einer vorhergegangenen \gls{xpath}- oder \gls{xslt}-Transformation. Der in der Transformation anzuwendende \gls{xpath}-Ausdruck
wird auf jeden Knoten in den Eingabedaten angewendet und das Ergebnis überprüft. Trifft der Ausdruck auf den Knoten zu, wird der Knoten in die Ausgabe der
Transformation übernommen, anderenfalls wird er nicht weitergegeben.

In \fref{lst:xml-dsig-transformation-xpath} wird gezeigt, wie \gls{xpath} dazu benutzt werden kann, die Elemente der eigenen \gls{xml-dsig}-Signatur aus den zu
signierenden Informationen zu filtern. Dies kann notwendig sein, wenn ein \xmlelem{Reference}-Element der Signatur auf das Dokument verweist, in dem die
Signatur selbst hinterlegt ist und somit Bestandteil der signierten Informationen wäre. Dies würde dazu führen, dass die Hash-Prüfsummen nicht korrekt wären, da
sie noch nicht Elemente wie \xmlelem{SignatureValue} berücksichtigen würden, welche erst nach Erstellung der Prüfsummen in die Signatur eingefügt werden können.
Die dafür benutze Bedingung \texttt{here()} in \fref{lin:xml-dsig-transformation-xpath-here} ist nicht Teil der \gls{xpath}-Spezifikation und ist nur im Kontext
von \gls{xml-dsig}-Transformationen gültig \cite{xml-dsig:w3c}.

Neben der allgemeinen Spezifikation 1.0 von \gls{xpath} \cite{xpath:w3c} wird auch eine eigene Abwandlung mit dem Namen "`XML-Signature XPath Filter 2.0"'
\cite{xml-dsig-filter:w3c} unterstützt, welche mehrere Filter in einer Transformation, sowie Schnittmengenbildung, Subtraktion und Vereinigung zwischen
Knoten-Mengen erlaubt. Sie ist speziell auf die Bedürfnisse von \gls{xml-dsig} angepasst und soll nach dem Wunsch ihrer Entwickler auch eine schnellere
Verarbeitung der Transformationen gewährleisten.

\lstinputlisting[language=XML,
                 caption={Filtern der eigenen Signatur aus einem Dokument},
                 label={lst:xml-dsig-transformation-xpath},
                 emph={XPath}]{source/xml-dsig-transformation-xpath.xml}

\subsection{\glsentrytext{xslt}}
\index{XSLT}
\label{sec:XML-DSig:Transformationen:XSLT}
Die Programmiersprache \gls{xslt} wird zur Transformation von \gls{xml}-Dokumenten eingesetzt und ist Teil der \gls{xsl} \cite{xml:oreilly}. Die Programme, die
die Instruktionen der Transformation enthalten, werden Stylesheets genannt und sind selbst \gls{xml}-Dokumente. Ein Interpreter, \gls{xslt}-Prozessor genannt,
nimmt ein solches Stylesheet als Eingabe und wandelt ein oder mehrere \gls{xml}-Dokumente, den \gls{xslt}-Instruktionen entsprechend, um. Das Format der Ausgabe ist
meist wieder \gls{xml}, kann jedoch auch reiner Text oder binäre Daten sein. \fref{fig:xslt-processing} zeigt den schematischen Aufbau einer solchen
Transformationskette.

\begin{figure}
    \centering
    \input{./figures/xslt-processing}
    \caption{Diagramm zum Ablauf einer \texorpdfstring{\protect\Glsentryname{xslt}}{XSLT}-Transformation}
    \label{fig:xslt-processing}
\end{figure}

Die einzelnen Instruktionschritte innerhalb eines Stylesheets werden auch Templates genannt, welche ein Muster in Form eines \gls{xpath}-Ausdrucks als Attribut besitzen. 
Trifft dieses Muster auf einen Knoten innerhalb des zu transformierenden \gls{xml}-Dokuments zu, so werden die Transformationen  aus dem Template auf diesen Knoten 
angewendet \cite{xslt:w3c,xml:oreilly}.

Für die Verwendung in \gls{xml-dsig} ist vorgesehen, dass das anzuwendende Stylesheet unter dem Element \xmlelem{Transform} abgelegt wird.
Je Transformation darf nur ein Stylesheet definiert werden \cite{xml-dsig:w3c}. Durch die Verwendung von \xmlelem{xsl:include} oder \xmlelem{xsl:import} im
Stylesheet ist es möglich entfernte Stylesheets einzubinden, zum Beispiel über \gls{http} oder aus einem lokalen Dateisystem. \gls{xml-dsig} selbst bietet keine
Möglichkeiten externe Stylesheets direkt anzubinden, wie dies bei \xmlelem{Reference} der Fall ist. 

Die Transformation setzt für die Eingangsdaten, im Gegensatz zu \gls{xpath}, einen Zeichenstrom voraus \cite{xml-dsig:w3c}. Bei einer vorgeschalteten
\gls{xpath}-Transformation muss die Ausgabe dieser zuerst wieder von einer Knoten-Menge in einen Zeichenstrom umgewandelt werden. Die Ausgabe der
\gls{xslt}-Transformation ist auch ein Zeichenstrom, für den empfohlen wird, ihn mit der Ausgabemethode \texttt{xml} von \gls{xslt} zu erzeugen \cite{xml-dsig:w3c}.

Das \fref{lst:xml-dsig-transformation-xslt} zeigt wie ein Stylesheet direkt in die Transformation einer Signatur eingebaut wird. Dabei wird das 
\xmlelem{ElementToTransform}, welches sich als Element außerhalb der Signatur befindet, auf \xmlelem{TransformedElement} umgewandelt und erst danach signiert.

\section{Signaturwert}
Im Element \xmlelem{SignatureValue} wird der Wert der eigentlichen Signatur gespeichert. Er wird dazu mit \gls{base64} umgewandelt und als alleiniger Wert dem
Element zugewiesen. Der Wert ist die Ausgabe der Anwendung des, in \xmlelem{SignatureMethod} definiterten, Signaturverfahren auf die, über \xmlelem{Reference} und
\xmlelem{Transform} erhaltenen, Informationen.

\lstinputlisting[language=XML,
                 float=p,
                 caption={\glsentrytext{xslt}-Transformation in einer Signatur},
                 label={lst:xml-dsig-transformation-xslt},
                 emph={ElementToTransform,TransformedElement}]{source/xml-dsig-transformation-xslt.xml}

