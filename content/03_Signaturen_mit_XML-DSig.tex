% vim: set tw=160:

\chapter{Signaturen mit XML-DSig}
\label{chap:XML-DSig}
\gls{xml-dsig} definiert ein \gls{xml}-Format das Informationen über die zu signierenden Inhalte, die Signaturen selbst und die zur Prüfung der Signaturen
notwendigen Schlüsselinformationen aufnimmt. Um \gls{xml-dsig} von anderen \gls{xml}-Formaten abzugrenzen wurde ihm der \gls{xml}-Namensraum
\url{http://www.w3.org/2000/09/xmldsig#} zugewiesen. 

\section{Struktur einer Signatur}
Eine Signatur mit \gls{xml-dsig} besteht aus mehreren Elementen die sich alle innerhalb von \xmlelem{Signature} befinden. \fref{lst:xml-dsig-structure} zeigt
die grundlegende Struktur einer Signatur mit \gls{xml-dsig}.

\lstinputlisting[language=XML,caption={Struktur von \texorpdfstring{\protect\Glsentryname{xml-dsig}}{XML-DSig}},label=lst:xml-dsig-structure,emph={Signature}]{source/xml-dsig-structure.xml}

Im folgenden werden die einzelnen Elemente dieser Struktur in ihrer Funktion näher beschrieben. 

\section{Schlüsselinformation}
Das optionale Element \xmlelem{KeyInfo} enthält Informationen zur Schlüssel, der bei der Erstellung der Signatur verwendet wurde. Diese Informationen sollen es
ermöglichen, dass der Empfänger die notwendigen Informationen zur Validierung der Signatur beziehen kann. \gls{xml-dsig} definiert eine Menge von
Schlüsseltypen, unter anderem für \gls{x509} und \gls{openpgp}, die jedoch auch abhängig von der Anwendung mit Hilfe neuer \glspl{xml-ns} erweitert werden
können. Das in \fref{lst:xml-dsig-keyinfo} dargestellte \gls{xml}-Schema zeigt die bereits definierten Elemente von \gls{xml-dsig} zur Aufnahme von
Schlüsselinformationen.

\lstinputlisting[language=XML,caption={Schema von \protect\xmlelem{KeyInfo}},label=lst:xml-dsig-keyinfo,emph={element}]{source/xml-dsig-keyinfo.xml}

Ist \xmlelem{KeyInfo} nicht Bestandteil der Signatur, dann wird davon ausgegangen, dass der Empfänger über den Kontext der Nachricht und der Signatur in der
Lage ist, die nötigen Schlüsselinformationen zu beziehen.

Über \xmlelem{KeyName} ist es dem Ersteller der Signatur möglich, den Schlüssel zu benennen, der für die Signatur benutzt wurde. Für \gls{x509} kann dies ein
\gls{dn} sein, für \gls{openpgp} eine E-Mail-Adresse. Über \xmlelem{KeyValue} ist es auch möglich, die für den \gls{dsa} oder das \gls{rsa} Verfahren
benötigten, Schlüsselinformationen direkt in der Signatur einzubetten.  

Alternativ können über das Element \xmlelem{RetrievalMethod} Schlüsselinformationen über \glspl{uri} referenziert werden. Dies können zum Beispiel
\gls{x509}-Zertifikate sein, die bereits in dem zu signierenden \gls{xml}-Dokument enthalten sind. \xmlelem{RetrievalMethod} entspricht bis auf
das Fehlen der Elemente \xmlelem{DigestMethod} und \xmlelem{DigestValue}i in seinem Verhalten dem Element \xmlelem{Reference} welches in 
\fref{sec:Signaturbindung:Referenzen} näher beschrieben wird.

\subsection{OpenPGP}
Für Schlüssel nach \gls{openpgp} wird das Element \xmlelem{PGPData} im \gls{xml-ns} \url{http://www.w3.org/2000/09/xmldsig#PGPData} definiert. Es ist in der
Lage, zwei weitere Elemente aufzunehmen: \xmlelem{PGPKeyID} nimmt die ID eines \gls{openpgp}-Schlüsselpaares auf, welche aus 8 \glspl{oktett} besteht und die
niedrigsten 64 Bit aus der \gls{sha1} Prüfsumme des Schlüssels darstellen \cite{openpgp:ietf}. Über die \xmlelem{PGPKeyID} ist der passende Schlüssel bereits eindeutig
identifiziert, es besteht mit dem Element \xmlelem{PGPKeyPacket} jedoch auch die Variante, den vollständigen öffentlichen Teil des Schlüsselpaares in der
Signatur einzubetten. Dafür wird das Schlüsselmaterial mit \gls{base64} kodiert und als Inhalt in das Element geschrieben \cite{xml-dsig:w3c}. Mindestens eines
der beiden Elemente muss innerhalb von \xmlelem{PGPData} vorhanden sein. Wenn beide angeführt sind, müssen sie den selben Schlüssel referenzieren.

\fref{lst:xml-dsig-keyinfo-openpgp} zeigt ein Beispiel für eine Struktur mit den zuvor genannten Unterelementen, welche auf den \gls{openpgp}-Schlüssel des Autors
referenzieren. In \fref{lin:xml-dsig-keyinfo-openpgp-keyid} wird der Schlüssel über seine ID verankert und ab \fref{lin:xml-dsig-keyinfo-openpgp-keypacket} als
vollständige Kopie in der Signatur eingebettet.

\lstinputlisting[language=XML,caption={Beispiel einer Struktur für \protect\xmlelem{PGPData}},label=lst:xml-dsig-keyinfo-openpgp,emph={PGPData,PGPKeyID,PGPKeyPacket}]{source/xml-dsig-keyinfo-openpgp.xml}

\subsection{X.509}
Informationen über ein für die Signatur verwendetes \gls{x509}-Zertifikat können unterhalb des Elements \xmlelem{X509Data} im dafür vorgesehenen \gls{xml-ns}
\url{http://www.w3.org/2000/09/xmldsig#X509Data} abgelegt werden. 
Ähnlich wie \xmlelem{PGPData} enthält es Schlüsselinformationen die zur Validierung der Signatur benötigt werden.  Dafür muss mindestens eines der Elemente aus
\fref{tab:x509data-elements} vorhanden sein. Wenn zwei oder mehrere dieser Elemente sich innerhalb eines \xmlelem{X509Data} befinden, so müssen sie alle das
selbe Zertifikat referenzieren. In \fref{lst:xml-dsig-keyinfo-x509} sind drei Zertifikate über unterschiedliche Methoden referenziert. 

\begin{table}[b]
    \centering
    \begin{tabularx}{\textwidth}{ l X }
        Element  & Inhalt \\
        \hline
        \hline
        \xmlelem{X509IssuerSerial} & Name und Seriennummer des Zertifikats \\
        \hline
        \xmlelem{X509SKI} & Mit \gls{base64} kodierter Inhalt der "`SubjectKeyIdentifier"' Erweiterung des Zertifikats \\
        \hline
        \xmlelem{X509Certificate} & Mit \gls{base64} kodierter Inhalt des gesamten Zertifikats \\
        \hline
        \xmlelem{X509SubjectName} & \gls{dn} des Subject-Felds des Zertifikats \\
        \hline
    \end{tabularx}
    \caption{Elemente in \xmlelem{X509Data} und ihr Inhalt}
    \label{tab:x509data-elements}
\end{table}

\lstinputlisting[float=b,language=XML,caption={Beispiel einer Struktur für \protect\xmlelem{X509Data}},label=lst:xml-dsig-keyinfo-x509,emph={X509Data,X509IssuerSerial,X509SKI,X509Certificate,X509SubjectName}]{source/xml-dsig-keyinfo-x509.xml}

\section{Signaturinformation}
Analog zu \xmlelem{KeyInfo} wird das Element \xmlelem{SignedInfo} verwendet um Informationen über die Signatur selbst zu speichern. Dazu gehören die benutzte
Signaturmethode, die Art der Normalisierung der Daten vor der Signierung sowie die Referenzen auf die signierten Daten und ihre Hash-Prüfsummen.

Alle in \gls{xml-dsig} anwendbaren Algorithmen werden über eigene \glspl{uri} referenziert. So kann das Signaturverfahren mit den \glspl{uri} aus
\fref{tab:xml-dsig-signature-method-uri} angegeben werden. Dazu muss für das Element \xmlelem{SignatureMethod} das obligatorische Attribut
\xmlattr{SignatureMethod}{Algorithm} mit der \gls{uri} eines Algorithmus befüllt werden.

\begin{table}
    \centering
    \begin{tabularx}{\textwidth}{ l X }
        Signaturmethode & \gls{uri} \\
        \hline
        \hline
        \gls{dsa}-\gls{sha1} & \url{http://www.w3.org/2000/09/xmldsig\#dsa-sha1} \\
        \hline
        \gls{rsa}-\gls{sha1} & \url{http://www.w3.org/2000/09/xmldsig\#rsa-sha1} \\
        \hline
    \end{tabularx}
    \caption{\protect\glspl{uri} für die Verwendung in \xmlelem{SignatureMethod}}
    \label{tab:xml-dsig-signature-method-uri}
\end{table}

Ein besonderes Problem beim Signieren von Inhalten, die im \gls{xml}-Format vorliegen. entsteht wenn mehrere Implementierungen von
\gls{xml}-Verarbeitungsprogrammen für Dokument jeweils unterschiedliche Formatierungen benutzen. So könnte ein Programm das \gls{xhtml}-Dokument aus
\fref{lst:xml-c14n-example-1} einlesen und später mit der in \fref{lst:xml-c14n-example-1} gezeigten Formatierung abspeichern. Beide Formate unterscheiden sich
in der Groß- und Kleinschreibung der Elementnamen, sowie der Verwendung von Leer- und Anführungszeichen oder Apostrophen. Strukturell und inhaltlich sind sie
trotzdem ident. \todo

Eine Signatur sollte deshalb nicht auf die binäre Repräsentation eines Dokumentes angewendet werden, sondern idealerweise auf seine kanonisierte
Struktur und den Inhalt. Dies geschieht bei \gls{xml-dsig} über den Zwischenschritt der \gls{c14n}, welche Struktur und Inhalt in eine kanonische Form überführt,
welche dann schließlich die zu signierenden Information bildet. Dadurch wird sichergestellt, dass die Signatur unabhängig von der Formatierung überprüft werden
kann und nur Änderungen an der Struktur oder dem Inhalt die Gültigkeit der Signatur beeinflussen. 

Bei \gls{xml-dsig} wird die Signatur nicht direkt über die zu schützenden Informationen gebildet, sondern es werden die gesamten Informationen innerhalb von
\xmlelem{SignedInfo} signiert. Die Verbindung zwischen den zu schützenden Informationen und der Signatur wird in \fref{sec:XML-DSig:Referenzen} näher erläutert.

Da \xmlelem{SignedInfo} selbst dem Problem der unterschiedlichen Formatierungen unterliegt, wird über das Element \xmlelem{CanonicalizationMethod} ein
Algorithmus angegeben, der die Umwandlung von \xmlelem{SignedInfo} in ein kanonisches Format festlegt. Innerhalb von \xmlelem{SignedInfo} muss das Element
\xmlelem{CanonicalizationMethod} genau einmal vorhanden sein. Der Algorithmus wird über das obligatorische Attribut \xmlattr{CanonicalizationMethod}{Algorithm}
bei \xmlelem{CanonicalizationMethod} definiert. Als Wert kommt eine von vier möglichen \glspl{uri} zu Einsatz, welche in \cite{xml-dsig:w3c} spezifiziert sind.

Es gibt jedoch Szenarien, in denen die \gls{c14n} dazu führt, dass die Signatur noch gültig bleibt, auch wenn Teile der signierten Information verändert wurden.
\todo

\section{Referenzen}
\label{sec:XML-DSig:Referenzen}
Um Daten für die \gls{c14n} zu bekommen benötigt \gls{xml-dsig} Referenzen, welche auf die signierten Informationen verweisen. Diese Information wird über das 
Element \xmlelem{Reference} zur Verfügung gestellt, welches mehrfach in \xmlelem{SignedInfo} enthalten sein kann. Jedes Vorkommen dieses Elements stellt einen
Verweis auf eine signierte Information dar. Der Verweis ist in Form eines \gls{uri} im optionalen Attribut \xmlattr{Reference}{URI} hinterlegt. Wenn
\xmlattr{Reference}{URI} nicht definiert ist, wird davon ausgegangen, dass die Applikation den Verweis aus dem Kontext der Signatur beziehen kann. Die
Entwickler von \gls{xml-dsig} empfehlen, dass zumindest \glspl{uri} aus dem \gls{http}-Schema aufgelöst werden können \cite{xml-dsig:w3c}. Ein entsprechendes
Beispiel für Informationen die über \gls{http} referenziert werden ist in \fref{lst:xml-dsig-signedinfo-reference} in der
\fref{lin:xml-dsig-signedinfo-reference-http} zu sehen.

\lstinputlisting[language=XML,caption={Beispiele für \protect\xmlelem{Reference}},label={lst:xml-dsig-signedinfo-reference},emph={Reference}]{source/xml-dsig-signedinfo-reference.xml}

Es können jedoch auch Informationen referenziert werden, die sich im selben \gls{xml}-Dokument wie die Signatur befinden. Dafür können im Attribut
\xmlattr{Reference}{URI} auch \gls{xpointer} benutzt werden. Dabei muss sichergestellt werden, dass der Verweis gültige \gls{xml}-Elemente findet.
\fref{lst:xml-dsig-signedinfo-reference} zeigt auf \fref{lin:xml-dsig-signedinfo-reference-xpointer} wie ein solcher Verweis innerhalb des \gls{xml}-Dokuments,
das die Signatur enthält, möglich ist.

\section{Transformationen}
\label{sec:XML-DSig:Transformationen}
Die Referenzierung auf Informationen alleine ist oft nicht genug, um aussagekräftige Signaturen zu erstellen, die nur die wirklich relevanten Bereiche eines
Dokuments umfassen. Mit dem Element \xmlelem{Transformation}, welches optional innerhalb von \xmlelem{Reference} verwendet werden kann, ist es möglich,
Transformationen zu definieren, die in der Reihenfolge ihrer Definition angewandt werden. Die erste Transformation erhält dabei ihre Eingabedaten aus der
Dereferenzierung des \gls{uri} des übergeordneten \xmlelem{Reference}-Elements. Danach werden die transformierten Daten an die nächste Transformation in der
Reihe übergeben. Die Ausgabe der letzten Transformation wird dann zur Berechnung einer Hash-Prüfsumme benutzt.

Als Transformationen stehen \gls{c14n}, \gls{base64}, \gls{xpath} und \gls{xslt} zur Verfügung. \gls{xpath} und \gls{xslt} sind geeignet, bestimmte Bereiche aus
einem referenzierten \gls{xml}-Dokument zu extrahieren und somit den Bereich der Signatur exakt zu begrenzen. \gls{c14n} bietet sich als eine der letzten
Transformationen in der Reihe an, da sie die Überführung des Transformationsergebnisses in eine kanonische Form bewerkstelligt und somit wieder Struktur und
Inhalt von der Formatierung trennt. Eine Transformation mit \gls{base64} ist nur bei Referenzen auf binäre Daten sinnvoll. Da \gls{base64} kein gültiges
\gls{xml} als Ausgabe der Transformation liefert, sind nachgeschaltete Transformationen mit \gls{xpath} und \gls{xslt} nicht mehr möglich.

\subsection{XPath}
\index{XPath}
\label{sec:XML-DSig:Transformationen:XPath}

\subsection{XSLT}
\index{XSLT}
\label{sec:XML-DSig:Transformationen:XSLT}

